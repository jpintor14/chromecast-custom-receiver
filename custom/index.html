<!DOCTYPE html>
<html>
<head>
</head>
<body>

    <table>
        <tr>
            <td>
                <div id="log" style="color: red; z-index: 9999; position: absolute">Log: </div>
            </td>
        </tr>
        <tr>
            <td>
                <cast-media-player id="player"></cast-media-player>
            </td>
        </tr>
    </table>

    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"> </script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" ></script>  
    <script src="rtvHandler.js"></script>
    <script>

        const channel = 'urn:x-cast:com.optm.anhplayer';
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        var licenseServerUrl = "https://orangetv.orange.es/mob/api/rtv/v1/drm";
        var cookies = [];
        var channel_external_id = "1000"
        var username = ""
        var pass = ""
        var profile = ""

        console.log("context getInstance()")
        addToLog("---------------------------------------------------")
        addToLog("context getInstance()");


        const options = new cast.framework.CastReceiverOptions();
        
        options.customNamespaces = {
            [channel]: cast.framework.system.MessageType.JSON
        };
        
        //context.start(options);



        // Update playback config licenseUrl according to provided value in load request.
        playerManager.setMediaPlaybackInfoHandler((loadRequest, playbackConfig) => {
            addToLog("setMediaPlaybackInfoHandler: ");
            addToLog("customData: " + JSON.stringify(loadRequest.media.customData));
            if (loadRequest.media.customData) {
                if (loadRequest.media.customData.licenseUrl) {
                    //playbackConfig.licenseUrl = loadRequest.media.customData.licenseUrl;
                    playbackConfig.licenseUrl = licenseServerUrl;
                    addToLog("licenseUrl: " + loadRequest.media.customData.licenseUrl);
                }
                if (loadRequest.media.customData.protectionSystem) {
                    addToLog("protectionSystem: " + loadRequest.media.customData.protectionSystem);
                    if (loadRequest.media.customData.protectionSystem === "WIDEVINE") {
                        playbackConfig.protectionSystem = cast.framework.ContentProtection.WIDEVINE;
                    } else
                        if (loadRequest.media.customData.protectionSystem === "PLAYREADY"){
                            playbackConfig.protectionSystem = cast.framework.ContentProtection.PLAYREADY;
                        }
                }
                if (loadRequest.media.customData.cookies) {
                    addToLog("cookies: " + loadRequest.media.customData.cookies);
                    cookies = loadRequest.media.customData.cookies;
                }
                if (loadRequest.media.customData.licenseCustomData) {
                    addToLog("licenseCustomData: " + loadRequest.media.customData.licenseCustomData);
                    playbackConfig.licenseCustomData = loadRequest.media.customData.licenseCustomData;
                    //playbackConfig.licenseCustomData = getLivePlayingInfoOrangeSeries()
                }
            }

            return playbackConfig;
        });



        const playbackConfig = new cast.framework.PlaybackConfig();
        playbackConfig.autoResumeDuration = 5;

        // A hook on the license request url
        playbackConfig.licenseRequestHandler = requestInfo => {
            console.log("licenseRequestHandler: " + requestInfo.url);
            addToLog("licenseRequestHandler: " + requestInfo.url);

            if (cookies.length != 0) {
                cookies.forEach(value => {
                    cookieName = value.split("=")[0];
                    cookieValue = value.split("=")[1];
                    requestInfo.headers[cookieName] = cookieValue;
                    addToLog("cookieName: " + cookieName);
                });
            }

            return requestInfo;
        };
        // A hook on the manifest when downloaded and parsed
        playbackConfig.manifestHandler = manifest => {
            console.log("manifestHandler: " + manifest);
            addToLog("manifestHandler: " + manifest)
            return manifest;
        };
        // A hook on the manifest request url
        playbackConfig.manifestRequestHandler = networkRequestInfo => {
            console.log("manifestRequestHandler: " + networkRequestInfo.url);
            addToLog("manifestRequestHandler: " + networkRequestInfo.url)

            //getLivePlayingInfo()
            //getVideoPlatingInfo

            rtv.getVideoPlatingInfo("1000", addToLog, setLicense)

            return networkRequestInfo;
        };

        context.addCustomMessageListener(channel, function(customEvent) {
            addToLog("addCustomMessageListener");
            var message = customEvent.data
            var command = message.command
            var params = message.params
            
            if (command == "switchLive"){
                clearLog();
                switchLiveChannel(params);
            }else{
                var text = params.text
                var log = "Message received from " + 
                            "[" +  customEvent.senderId +  "],  " +
                            " command: " + command + 
                            " text: " + text;
                addToLog(log);
            }

          });


        options.playbackConfig = playbackConfig
        context.start(options);

        addToLog("context started")


        function addToLog(message){
            document.getElementById("log").innerHTML += "<br> >>>" + message
        }


        function clearLog(){
            document.getElementById("log").innerHTML = ""
        }

        function switchLiveChannel(params){
            channel_external_id = params.channelExternalId
            addToLog("channel_external_id: " + channel_external_id)
            //getLivePlayingInfo()
        }


    /*
    function getVideoPlatingInfo(){
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "https://orangetv.orange.es/mob/api/rtv/v1/GetVideoPlayingInfo?model_external_id=Chromecast&video_external_id=PRG_0000061190HD_DUPLICATED&client=json&serial_number=FD0DADFF0D46E7D656500EDAA91C264E", true);
        xhttp.withCredentials = true
        xhttp.send();

        
        xhttp.onreadystatechange = function() {
            addToLog("getLivePlayingInfo");
            var response = JSON.parse(xhttp.responseText)["response"];
            casToken = response["token"]
            playingUrl = response["url"]
            addToLog("response " + xhttp.responseText );
            
            initPlaybackConfig()
        }
        

        return casToken
    }
    */

    function initPlaybackConfig(){
        
        addToLog("initPlaybackConfig");

        playbackConfig.licenseCustomData = casToken


        addToLog("play");
        
        playerManager.play()


        addToLog("played");


        /*
        context.sendCustomMessage(channel, {
            type: 'status',
            message: 'Playing'
        });
        */

        var sender = context.getSenders()
        sender.forEach(printSender)
    }

    function printSender(item, index) {
        addToLog(item.id)
    }



    var log = function printLog(message){
        document.getElementById("log").innerHTML += "<br> >>>" + message
    }

    var setLicense = function setLicenseCustomData(){
        addToLog("initPlaybackConfig");
        var casToken = rtv.getCasToken()
        addToLog("casToken" + casToken);
        playbackConfig.customData = casToken
        playerManager.play()
    }


    var rtv = new rtvHandler();
    rtv.loginWithData("410000345", "aaaa1111", "2597776", log );

    </script>


</body>
</html>