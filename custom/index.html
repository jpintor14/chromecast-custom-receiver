<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
</head>
<body>

    <table>
        <tr>
            <td>
                <div id="log" style="color: red; z-index: 9999; position: absolute">Log: </div>
            </td>
        </tr>
        <tr>
            <td>
                <cast-media-player id="player"></cast-media-player>
            </td>
        </tr>
    </table>

    <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"> </script>
    <script>

        const channel = 'urn:x-cast:com.optm.anhplayer';
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        const licenseServerUrl = "https://orangetv.orange.es/mob/api/rtv/v1/drm";
        var cookies = [];
        var username = ""
        var password = ""

        console.log("context getInstance()")
        addToLog("---------------------------------------------------")
        addToLog("context getInstance()");


        const options = new cast.framework.CastReceiverOptions();
        
        options.customNamespaces = {
            [channel]: cast.framework.system.MessageType.JSON
        };
        
        //context.start(options);



        // Update playback config licenseUrl according to provided value in load request.
        playerManager.setMediaPlaybackInfoHandler((loadRequest, playbackConfig) => {


            addToLog("setMediaPlaybackInfoHandler - customData: " + JSON.stringify(loadRequest.media.customData));

            if (loadRequest.media.customData) {


                playbackConfig.licenseCustomData = loadRequest.media.customData


                /*
                if (loadRequest.media.customData.licenseUrl) {
                    //playbackConfig.licenseUrl = loadRequest.media.customData.licenseUrl;
                    playbackConfig.licenseUrl = licenseServerUrl;
                    addToLog("licenseUrl: " + loadRequest.media.customData.licenseUrl);
                }
                if (loadRequest.media.customData.protectionSystem) {
                    addToLog("protectionSystem: " + loadRequest.media.customData.protectionSystem);
                    if (loadRequest.media.customData.protectionSystem === "WIDEVINE") {
                        playbackConfig.protectionSystem = cast.framework.ContentProtection.WIDEVINE;
                    } else
                        if (loadRequest.media.customData.protectionSystem === "PLAYREADY"){
                            playbackConfig.protectionSystem = cast.framework.ContentProtection.PLAYREADY;
                        }
                }
                if (loadRequest.media.customData.cookies) {
                    addToLog("cookies: " + loadRequest.media.customData.cookies);
                    cookies = loadRequest.media.customData.cookies;
                }
                if (loadRequest.media.customData.licenseCustomData) {
                    addToLog("licenseCustomData: " + loadRequest.media.customData.licenseCustomData);
                    playbackConfig.licenseCustomData = loadRequest.media.customData.licenseCustomData;
                }
                */
            }

            return playbackConfig;
        });


        playerManager.addEventListener(cast.framework.events.EventType.PLAYER_LOAD_COMPLETE,
            event => {

                addToLog("on PLAYER_LOAD_COMPLETE: contentId " + event.media.contentId);

                for (var i = 0; i < event.media.tracks.length; i++) {

                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].language " + event.media.tracks[i].language);
                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].name: " + event.media.tracks[i].name);
                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].subtype: " + event.media.tracks[i].subtype);
                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].trackContentId: " + event.media.tracks[i].trackContentId);
                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].trackContentType: " + event.media.tracks[i].trackContentType);
                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].trackId: " + event.media.tracks[i].trackId);
                    addToLog("on PLAYER_LOAD_COMPLETE: tracks[" + i + "].type: " + event.media.tracks[i].type);
                }
            }
        );

        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            request => {
                addToLog("----- LOAD -----");
                // Resolve entity to content id


                playerManager.play()
                /*
                addToLog("----- LOAD ----- media: " + JSON.stringify(request.media));


                for (var prop in request.media) {
                    if (Object.prototype.hasOwnProperty.call(request.media, prop)) {
                        addToLog("prop: " + prop + " - " + request.media[prop])
                    }
                }
                */

                if (request.media.entity && !request.media.contentId) {
                    addToLog("----- LOAD ----- contentId " + request.media.contentId);
                    return getMediaByEntity(request.media.entity).then(
                        media => {
                        request.media.contentId = media.url;
                        return request;
                        });
            }
            return request;
        });



        const playbackConfig = new cast.framework.PlaybackConfig();
        playbackConfig.autoResumeDuration = 5;
        playbackConfig.licenseUrl = licenseServerUrl;

        // A hook on the license request url
        playbackConfig.licenseRequestHandler = requestInfo => {
            console.log("licenseRequestHandler: " + requestInfo.url);
            addToLog("licenseRequestHandler: " + requestInfo.url);

            if (cookies.length != 0) {
                cookies.forEach(value => {
                    cookieName = value.split("=")[0];
                    cookieValue = value.split("=")[1];
                    requestInfo.headers[cookieName] = cookieValue;
                    addToLog("cookieName: " + cookieName);
                });
            }

            return requestInfo;
        };



        playerManager.addEventListener(cast.framework.events.EventType.MEDIA_STATUS,
            event => {
                console.log("on MEDIA_STATUS: " + event.mediaStatus.playerState);
                if (event.mediaStatus.activeTrackIds) {
                    console.log("on MEDIA_STATUS: number of active track " + event.mediaStatus.activeTrackIds.length);
                    if (event.mediaStatus.activeTrackIds.length >= 1) {
                        console.log("on MEDIA_STATUS: first trackId " + event.mediaStatus.activeTrackIds[0]);
                        if (event.mediaStatus.activeTrackIds.length == 2) {
                            console.log("on MEDIA_STATUS: second trackId " + event.mediaStatus.activeTrackIds[1]);
                        }
                    }
                }
            }
        );

        // A hook on the manifest when downloaded and parsed
        playbackConfig.manifestHandler = manifest => {
            console.log("manifestHandler: " + manifest);
            addToLog("manifestHandler: " + manifest)
            return manifest;
        };
        // A hook on the manifest request url
        playbackConfig.manifestRequestHandler = networkRequestInfo => {
            console.log("manifestRequestHandler: " + networkRequestInfo.url);
            addToLog("manifestRequestHandler: " + networkRequestInfo.url)

            //getLivePlayingInfo()
            //getVideoPlatingInfo

            return networkRequestInfo;
        };

        context.addCustomMessageListener(channel, function(customEvent) {
            clearLog();
            addToLog("addCustomMessageListener");
            var message = customEvent.data;
            var command = message.command;
            var params = message.params;

            if (command == "login"){
                loginWithParams(params);
            }else{
                var text = params.text
                var log = "Message received from " + 
                            "[" +  customEvent.senderId +  "],  " +
                            " command: " + command + 
                            " text: " + text;
                addToLog(log);
            }
          });


        options.playbackConfig = playbackConfig
        context.start(options);

        addToLog("context started")


        function clearLog(){
            document.getElementById("log").innerHTML = ""
        }

        function addToLog(message){
            document.getElementById("log").innerHTML += "<br> >>>" + message
        }

        function loginWithParams(params){
            username = params.username
            password = params.password
            postLogin()
        }

        function postLogin(){
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", "https://orangetv.orange.es/mob/api/rtv/v1/Login?client=json", true);
            xhttp.withCredentials = true
            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhttp.send("username=" + username +"&password=" + password);

            xhttp.onreadystatechange = function() {

                if (this.readyState == 4 && this.status == 200) {
                    addToLog("postLogin")
                    addToLog("response: " + xhttp.responseText )
                    var status = JSON.parse(xhttp.responseText)["response"]["status"] 
                    addToLog("response: " + status )
                    //orderVideo()
                    //if (status == "SUCCESS"){
                        //loginWithProfile()
                    //}
                }
            }
        }


        /*
        function orderVideo(){
            var xhttpLivePlaying = new XMLHttpRequest();
            xhttpLivePlaying.open("GET", "https://orangetv.orange.es/mob/api/rtv/v1/OrderVideo?pricing_id=8779&viewing_method=streaming&client=json&subscription=true&external_video_id=PRG_0000043974HD_DUPLICATED", true);
            xhttpLivePlaying.withCredentials = true
            xhttpLivePlaying.send();


            xhttpLivePlaying.onreadystatechange = function() {

                if (this.readyState == 4 && this.status == 200) {
                    addToLog("orderVideo");
                    var response = JSON.parse(xhttpLivePlaying.responseText)["response"];
                }
            }
        }

        function loginWithProfile(){
            var xhttpLoginProfile = new XMLHttpRequest();
            xhttpLoginProfile.open("GET", "https://orangetv.orange.es/mob/api/reco/v1/Login?client=json&profile_id=" + profileId, true);
            xhttpLoginProfile.withCredentials = true
            xhttpLoginProfile.send();


            xhttpLoginProfile.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    addToLog("loginWithProfile")
                    addToLog("response " + JSON.parse(xhttpLoginProfile.responseText)["response"] )
                }
            }

        }
        */


        /*
        function getLivePlayingInfo(){
            var xhttpLivePlaying = new XMLHttpRequest();
            xhttpLivePlaying.open("GET", "https://orangetv.orange.es/mob/api/rtv/v1/GetLivePlayingInfo?client=json&include_cas_token=true&channel_external_id=1000&serial_number=FD0DADFF0D46E7D656500EDAA91C264E", true);
            xhttpLivePlaying.withCredentials = true
            xhttpLivePlaying.send();


            xhttpLivePlaying.onreadystatechange = function() {

                if (this.readyState == 4 && this.status == 200) {
                    addToLog("getLivePlayingInfo");
                    var response = JSON.parse(xhttpLivePlaying.responseText)["response"];
                    casToken = response["casToken"]
                    playingUrl = response["playingUrl"]
                    addToLog("response " + xhttpLivePlaying.responseText );
                    
                    initPlaybackConfig()
                }
            }
        }

        
        function getVideoPlatingInfo(){
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "https://orangetv.orange.es/mob/api/rtv/v1/GetVideoPlayingInfo?model_external_id=Chromecast&video_external_id=PRG_0000061190HD_DUPLICATED&client=json&serial_number=FD0DADFF0D46E7D656500EDAA91C264E", true);
            xhttp.withCredentials = true
            xhttp.send();

            
            xhttp.onreadystatechange = function() {
                addToLog("getLivePlayingInfo");
                var response = JSON.parse(xhttp.responseText)["response"];
                casToken = response["token"]
                playingUrl = response["url"]
                addToLog("response " + xhttp.responseText );
                
                initPlaybackConfig()
            }
            

            return casToken
        }
        

        function initPlaybackConfig(){
            
            addToLog("initPlaybackConfig");

            playbackConfig.licenseCustomData = casToken

            addToLog("play");
            
            //playerManager.play()
            //addToLog("played");
        }

        function printSender(item, index) {
            addToLog(item.id)
        }
        */

    </script>
    <script>
        //postLogin()
    </script>


</body>
</html>